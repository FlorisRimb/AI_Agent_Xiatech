/****************************************************
 * DATABASE: retail_db
 * DESCRIPTION:
 *   This script creates three MongoDB collections
 *   for a basic product and sales management system:
 *   - products
 *   - stock_levels
 *   - sales_transactions
 *   It defines structure, validation rules, and indexes.
 ****************************************************/

// Select or create the database
use retail_db;

/****************************************************
 * COLLECTION: products
 * DESCRIPTION:
 *   Stores product information.
 *   Each product is uniquely identified by its SKU.
 ****************************************************/
db.createCollection("products", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["sku", "name", "category", "price"],
      properties: {
        sku: {
          bsonType: "string",
          description: "Unique product identifier (SKU)"
        },
        name: {
          bsonType: "string",
          description: "Product name"
        },
        category: {
          bsonType: "string",
          description: "Product category"
        },
        price: {
          bsonType: "double",
          minimum: 0,
          description: "Product unit price"
        }
      }
    }
  },
  comment: "List of all available products"
});

// Unique index on SKU
db.products.createIndex({ sku: 1 }, { unique: true, name: "idx_unique_sku" });

/****************************************************
 * COLLECTION: stock_levels
 * DESCRIPTION:
 *   Stores the current stock level for each product.
 ****************************************************/
db.createCollection("stock_levels", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["sku", "stock_on_hand"],
      properties: {
        sku: {
          bsonType: "string",
          description: "Product identifier (matches products.sku)"
        },
        stock_on_hand: {
          bsonType: "int",
          minimum: 0,
          description: "Current quantity in stock"
        }
      }
    }
  },
  comment: "Current stock quantity per product"
});

// One-to-one relationship with products via SKU
db.stock_levels.createIndex({ sku: 1 }, { unique: true, name: "idx_unique_sku" });

/****************************************************
 * COLLECTION: sales_transactions
 * DESCRIPTION:
 *   Records all product sales transactions.
 ****************************************************/
db.createCollection("sales_transactions", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["transaction_id", "sku", "timestamp", "quantity"],
      properties: {
        transaction_id: {
          bsonType: "string",
          description: "Unique sales transaction ID"
        },
        sku: {
          bsonType: "string",
          description: "Product identifier (matches products.sku)"
        },
        timestamp: {
          bsonType: "date",
          description: "Date and time of the sale"
        },
        quantity: {
          bsonType: "int",
          minimum: 1,
          description: "Quantity sold in this transaction"
        }
      }
    }
  },
  comment: "History of all sales transactions"
});

// Unique index on transaction_id
db.sales_transactions.createIndex({ transaction_id: 1 }, { unique: true, name: "idx_unique_transaction_id" });

// Index on SKU for faster lookups
db.sales_transactions.createIndex({ sku: 1 }, { name: "idx_sku" });